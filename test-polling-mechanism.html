<!DOCTYPE html>
<html>
<head>
    <title>Polling Mechanism Test</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #app { max-width: 1200px; margin: 0 auto; }
        .chart-wrapper { 
            width: 100%; 
            height: 400px; 
            border: 1px solid #ccc; 
            margin: 20px 0;
            background: white;
        }
        #chart { width: 100%; height: 100%; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin-right: 10px; }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 20px 0; 
            max-height: 300px; 
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warn { color: orange; }
        .success { color: green; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Polling Mechanism Test</h1>
        <p>Testing chart readiness detection with polling instead of fixed delays</p>
        
        <div class="controls">
            <button @click="initWithDelay">Init With Delayed Data</button>
            <button @click="initInstantly">Init Instantly</button>
            <button @click="triggerResize">Trigger Resize</button>
            <button @click="clearChart">Clear Chart</button>
            <button @click="clearLog">Clear Log</button>
        </div>
        
        <div class="chart-wrapper" ref="wrapperRef">
            <div id="chart" ref="chartRef"></div>
        </div>
        
        <div class="log">
            <div v-for="entry in log" :key="entry.id" :class="entry.type">
                {{ entry.time }}: {{ entry.msg }}
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;
        
        createApp({
            setup() {
                const chartRef = ref(null);
                const wrapperRef = ref(null);
                const log = ref([]);
                let chart = null;
                let logId = 0;
                
                const addLog = (msg, type = 'info') => {
                    const entry = {
                        id: ++logId,
                        time: new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds(),
                        msg: msg,
                        type: type
                    };
                    log.value.push(entry);
                    console.log(`[${type.toUpperCase()}] ${msg}`);
                };
                
                const clearLog = () => {
                    log.value = [];
                };
                
                // Check if chart is ready
                const isChartReady = () => {
                    if (!chart || chart.isDisposed()) {
                        return false;
                    }
                    
                    try {
                        const opts = chart.getOption();
                        if (!opts || Object.keys(opts).length === 0) {
                            return false;
                        }
                        
                        // Check for coordinate systems
                        if (opts.series && opts.series.length > 0) {
                            const needsCartesian = opts.series.some(s => 
                                ['line', 'bar', 'scatter'].includes(s.type)
                            );
                            
                            if (needsCartesian) {
                                if (!opts.xAxis || opts.xAxis.length === 0 || !opts.yAxis || opts.yAxis.length === 0) {
                                    return false;
                                }
                            }
                        }
                        
                        return true;
                    } catch (e) {
                        return false;
                    }
                };
                
                // Wait for chart to be ready with polling
                const waitForChartReady = (callback, maxAttempts = 50, interval = 10) => {
                    let attempts = 0;
                    
                    const checkReady = () => {
                        attempts++;
                        addLog(`Checking readiness... (attempt ${attempts})`, 'info');
                        
                        if (isChartReady()) {
                            addLog(`Chart ready after ${attempts} attempts (${attempts * interval}ms)`, 'success');
                            callback();
                        } else if (attempts >= maxAttempts) {
                            addLog(`Chart not ready after ${maxAttempts} attempts, proceeding anyway`, 'warn');
                            callback();
                        } else {
                            setTimeout(checkReady, interval);
                        }
                    };
                    
                    checkReady();
                };
                
                // Resize with polling
                const resizeWithPolling = () => {
                    addLog('Resize requested, waiting for chart readiness...', 'info');
                    
                    if (!chart || chart.isDisposed()) {
                        addLog('No chart to resize', 'warn');
                        return;
                    }
                    
                    waitForChartReady(() => {
                        try {
                            const opts = chart.getOption();
                            addLog(`Resizing chart. Has xAxis: ${!!opts.xAxis}, Has yAxis: ${!!opts.yAxis}`, 'info');
                            chart.resize();
                            addLog('Resize completed successfully', 'success');
                        } catch (e) {
                            addLog('Error during resize: ' + e.message, 'error');
                        }
                    });
                };
                
                // Initialize chart with simulated delayed data loading
                const initWithDelay = () => {
                    addLog('Initializing chart with delayed data...', 'info');
                    
                    if (chart && !chart.isDisposed()) {
                        chart.dispose();
                    }
                    
                    chart = echarts.init(chartRef.value);
                    addLog('Chart instance created', 'info');
                    
                    // Simulate delayed data loading
                    addLog('Simulating data loading delay...', 'info');
                    setTimeout(() => {
                        addLog('Setting chart options after delay', 'info');
                        chart.setOption({
                            title: { text: 'Delayed Data Chart' },
                            xAxis: { type: 'category', data: ['A', 'B', 'C', 'D', 'E'] },
                            yAxis: { type: 'value' },
                            series: [{ type: 'bar', data: [10, 20, 30, 40, 50] }]
                        });
                        addLog('Options set, now triggering resize', 'info');
                        
                        // Try to resize immediately after setting options
                        resizeWithPolling();
                    }, 100);
                };
                
                // Initialize chart instantly
                const initInstantly = () => {
                    addLog('Initializing chart instantly...', 'info');
                    
                    if (chart && !chart.isDisposed()) {
                        chart.dispose();
                    }
                    
                    chart = echarts.init(chartRef.value);
                    addLog('Chart instance created', 'info');
                    
                    // Set options immediately
                    chart.setOption({
                        title: { text: 'Instant Chart' },
                        xAxis: { type: 'category', data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] },
                        yAxis: { type: 'value' },
                        series: [{ type: 'line', data: [20, 22, 21, 23, 25] }]
                    });
                    addLog('Options set immediately', 'info');
                    
                    // Try to resize immediately
                    resizeWithPolling();
                };
                
                const triggerResize = () => {
                    addLog('Manual resize triggered', 'info');
                    resizeWithPolling();
                };
                
                const clearChart = () => {
                    if (chart && !chart.isDisposed()) {
                        addLog('Clearing chart', 'info');
                        chart.clear();
                    }
                };
                
                onMounted(() => {
                    addLog('Component mounted', 'info');
                    // Initialize with instant chart by default
                    initInstantly();
                });
                
                onUnmounted(() => {
                    if (chart && !chart.isDisposed()) {
                        chart.dispose();
                    }
                });
                
                return {
                    chartRef,
                    wrapperRef,
                    log,
                    initWithDelay,
                    initInstantly,
                    triggerResize,
                    clearChart,
                    clearLog
                };
            }
        }).mount('#app');
    </script>
</body>
</html>